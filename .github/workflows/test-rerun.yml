name: Test re-run

on:
  workflow_dispatch:

jobs:
  SuccessfulJob:
    runs-on: ubuntu-latest
    name: Successful Job
    strategy:
      fail-fast: false
    steps:
      - run: echo 'Successful job'

  FailedJob:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    name: Failed Job
    steps:
      - run: | 
          echo 'Failed job'
          exit 1

  Finalize-Result:
    name: Finalize Results
    needs:
      - SuccessfulJob
      - FailedJob
    runs-on: ubuntu-latest
    if: always()
    steps:
    - uses: technote-space/workflow-conclusion-action@v3
    - name: check-re-run
      if: ${{ env.WORKFLOW_CONCLUSION == 'failure' }}
      run: |
        runs=`curl -s -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{secrets.GITHUB_TOKEN }}" https://api.github.com/repos/irfanazam1/githubactions/actions/runs/${{ github.run_id }} | jq -r '.run_attempt'`
        echo "Runs = $runs"
        if [ $runs = "1" ];
        then
          curl --fail --request POST --url "https://api.github.com/repos/irfanazam1/githubactions/actions/runs/${{ github.run_id }}/rerun-failed-jobs" \
          --header "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          --header 'content-type: application/json'
        fi
